<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Form Submission</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        h1 {
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .log {
            font-family: monospace;
            white-space: pre-wrap;
            background-color: #f5f5f5;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            color: red;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Debug Form Submission</h1>
        <p>Tool này giúp xác định chính xác lỗi khi gửi form đăng ký xe</p>

        <form id="debugForm" enctype="multipart/form-data">            <div class="form-group">
                <label for="brand">Hãng xe</label>
                <select name="brand" id="brand" required>
                    <option value="">Chọn hãng xe</option>
                    <option value="Toyota">Toyota</option>
                    <option value="Honda">Honda</option>
                    <option value="Mazda">Mazda</option>
                    <option value="Ford">Ford</option>
                    <option value="Hyundai">Hyundai</option>
                    <option value="KIA">KIA</option>
                    <option value="VinFast">VinFast</option>
                    <option value="other">Khác</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="model">Mẫu xe</label>
                <input type="text" name="model" id="model" placeholder="VD: Vios" required>
            </div>
              <div class="form-group">
                <label for="year">Năm sản xuất</label>
                <input type="number" name="year" id="year" min="2000" max="2025" required>
            </div>
            
            <div class="form-group">
                <label for="seats">Số chỗ ngồi</label>
                <select name="seats" id="seats" required>
                    <option value="">Chọn số chỗ</option>
                    <option value="4">4 chỗ</option>
                    <option value="5">5 chỗ</option>
                    <option value="7">7 chỗ</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="transmission">Loại hộp số</label>
                <select name="transmission" id="transmission" required>
                    <option value="">Chọn loại hộp số</option>                    <option value="Số sàn">Số sàn</option>
                    <option value="Số tự động">Số tự động</option>
                    <option value="Số CVT">Số CVT</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="fuel">Loại nhiên liệu</label>
                <select name="fuel" id="fuel" required>
                    <option value="">Chọn loại nhiên liệu</option>
                    <option value="Xăng">Xăng</option>
                    <option value="Dầu diesel">Dầu diesel</option>
                    <option value="Điện">Điện</option>
                    <option value="Hybrid">Hybrid</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="license_plate">Biển số xe</label>
                <input type="text" name="license_plate" id="license_plate" placeholder="VD: 30A-12345" required>
            </div>
              <div class="form-group">
                <label for="price_per_day">Giá cho thuê (VND/ngày)</label>
                <input type="number" name="price_per_day" id="price_per_day" min="100000" step="10000" value="100000" required>
            </div>
            
            <div class="form-group">
                <label for="deposit">Tiền đặt cọc (VND)</label>
                <input type="number" name="deposit" id="deposit" min="0" step="100000" value="1000000">
            </div>
            
            <div class="form-group">
                <label for="km_limit">Giới hạn số KM/ngày (để trống nếu không giới hạn)</label>
                <input type="number" name="km_limit" id="km_limit" min="0" value="">
            </div>
              <div class="form-group">
                <label for="location">Địa chỉ đón/trả xe</label>
                <input type="text" name="location" id="location" value="51/34 phú mỹ, phường 22, quận bình thạnh" required>
            </div>
            
            <div class="form-group">
                <label for="description">Mô tả xe</label>
                <textarea name="description" id="description" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label>Tính năng xe (chọn các tính năng có trên xe)</label>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                    <div>
                        <input type="checkbox" id="feature_gps" name="features" value="GPS">
                        <label for="feature_gps" style="display: inline;">GPS</label>
                    </div>
                    <div>
                        <input type="checkbox" id="feature_bluetooth" name="features" value="Bluetooth" checked>
                        <label for="feature_bluetooth" style="display: inline;">Bluetooth</label>
                    </div>
                    <div>
                        <input type="checkbox" id="feature_backup_camera" name="features" value="Camera lùi" checked>
                        <label for="feature_backup_camera" style="display: inline;">Camera lùi</label>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="dummy_images">Giả lập hình ảnh xe (không cần tải thực)</label>
                <input type="file" id="dummy_images" name="car_images" multiple disabled>
                <div style="color: #666; margin-top: 5px;">* Trong tool debug này, chúng ta bỏ qua việc tải file</div>
            </div>
            
            <div class="form-group">
                <label for="type">Loại xe (mặc định là self-drive)</label>
                <select name="type" id="type">
                    <option value="self-drive" selected>Tự lái</option>
                </select>
            </div>

            <button type="submit">Kiểm tra Form</button>
        </form>
        
        <div class="result" id="result" style="display: none;">
            <h2>Kết quả kiểm tra</h2>
            <div class="error" id="errorMessage"></div>
            <div class="log" id="requestLog"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        document.getElementById('debugForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const result = document.getElementById('result');
            const errorMessage = document.getElementById('errorMessage');
            const requestLog = document.getElementById('requestLog');
            
            result.style.display = 'block';
            errorMessage.textContent = '';
            requestLog.innerHTML = 'Đang xử lý...\n';
            
            // Thu thập dữ liệu từ form
            const formData = new FormData(this);
            
            // Log dữ liệu form
            let formDataLog = 'Dữ liệu Form đang gửi:\n';
            for (let [key, value] of formData.entries()) {
                formDataLog += `${key}: ${value}\n`;
            }
            requestLog.innerHTML += formDataLog + '\n';
            
            // Hiển thị các trường bắt buộc theo mã nguồn
            requestLog.innerHTML += 'Trường bắt buộc theo controller:\n';
            requestLog.innerHTML += '- brand: ' + (formData.get('brand') ? 'OK' : 'THIẾU') + '\n';
            requestLog.innerHTML += '- model: ' + (formData.get('model') ? 'OK' : 'THIẾU') + '\n';
            requestLog.innerHTML += '- year: ' + (formData.get('year') ? 'OK' : 'THIẾU') + '\n';
            requestLog.innerHTML += '- seats: ' + (formData.get('seats') ? 'OK' : 'THIẾU') + '\n';
            requestLog.innerHTML += '- transmission: ' + (formData.get('transmission') ? 'OK' : 'THIẾU') + '\n';
            requestLog.innerHTML += '- fuel: ' + (formData.get('fuel') ? 'OK' : 'THIẾU') + '\n';
            requestLog.innerHTML += '- license_plate: ' + (formData.get('license_plate') ? 'OK' : 'THIẾU') + '\n';
            requestLog.innerHTML += '- price_per_day: ' + (formData.get('price_per_day') ? 'OK' : 'THIẾU') + '\n';
            requestLog.innerHTML += '- location: ' + (formData.get('location') ? 'OK' : 'THIẾU') + '\n\n';
            
            try {
                // Check token first
                const token = localStorage.getItem('token');
                if (!token) {
                    errorMessage.textContent = 'Lỗi: Không có token đăng nhập. Vui lòng đăng nhập trước.';
                    return;
                }
                
                requestLog.innerHTML += 'Token đăng nhập: ✓\n\n';
                requestLog.innerHTML += 'Đang gửi yêu cầu đến server...\n';
                
                // Đặt timeout lâu hơn cho request
                const instance = axios.create({
                    timeout: 20000 // 20 seconds
                });
                
                // Mô phỏng gửi request nhưng không thực sự gửi file
                const debugData = {
                    brand: formData.get('brand'),
                    model: formData.get('model'),
                    year: formData.get('year'),
                    seats: formData.get('seats'),
                    transmission: formData.get('transmission'),
                    fuel: formData.get('fuel'),
                    license_plate: formData.get('license_plate'),
                    price_per_day: formData.get('price_per_day'),
                    deposit: formData.get('deposit'),
                    km_limit: formData.get('km_limit'),
                    location: formData.get('location'),
                    description: formData.get('description'),
                    type: formData.get('type') || 'self-drive',
                    // Không gửi file thực sự
                    has_car_images: true,
                    has_registration_image: true
                };
                
                requestLog.innerHTML += 'Dữ liệu JSON sẽ gửi:\n' + JSON.stringify(debugData, null, 2) + '\n\n';
                
                // Log request
                requestLog.innerHTML += 'Đang gửi request thử nghiệm thay vì thực sự gửi...\n';
                requestLog.innerHTML += 'Điều này giúp kiểm tra cấu trúc dữ liệu mà không tốn tài nguyên server.\n\n';
                
                requestLog.innerHTML += 'Phân tích tiềm ẩn:\n';
                requestLog.innerHTML += '1. Định dạng biển số: ' + (/^[0-9]{2}[A-Z]{1,2}-[0-9]{4,5}$/.test(formData.get('license_plate')) ? 'Hợp lệ' : 'Không hợp lệ') + '\n';
                requestLog.innerHTML += '2. Giá thuê xe: ' + (parseInt(formData.get('price_per_day')) >= 100000 ? 'Hợp lệ' : 'Không hợp lệ') + '\n';
                requestLog.innerHTML += '3. Kiểm tra type xe: ' + (formData.get('type') === 'self-drive' ? 'OK' : 'Có thể không đúng giá trị mong đợi') + '\n';
                
            } catch (error) {
                errorMessage.textContent = 'Lỗi: ' + (error.response?.data?.message || error.message);
                requestLog.innerHTML += 'Error: ' + JSON.stringify(error.response?.data || error.message, null, 2);
            }
        });
        
        // Tự động điền giá trị mặc định
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('brand').value = 'Toyota';
            document.getElementById('model').value = 'Vios';
            document.getElementById('year').value = '2022';
            document.getElementById('seats').value = '5';
            document.getElementById('transmission').value = 'Số tự động';
            document.getElementById('fuel').value = 'Xăng';
            document.getElementById('license_plate').value = '30A-12345';
            document.getElementById('price_per_day').value = '500000';
            document.getElementById('deposit').value = '5000000';
        });
    </script>
</body>
</html>
